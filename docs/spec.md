# NiconiCompare 仕様書

本書はブラウザ拡張「NiconiCompare」の設計・実装に必要な仕様を、重複なく整理したものである。

---

## 1. 概要

- **目的**: 視聴中のニコニコ動画を直前動画と比較し続け、ユーザーの嗜好をレーティング／ランキング化して可視化する。
- **価値**: 視聴フローを妨げず好みを蓄積し、後からランキング・整理に活用できる。
- **方式**: Event sourcing で比較イベントを蓄積し、Glicko-2 でレーティングを算出。UI はブラウザ拡張として提供。

## 2. 目的と非目標

- **目的**:
  - 視聴しながら比較を素早く記録できる。
  - ログをリプレイすれば常に同じレーティング結果を得られる。
  - ランキングやフィルタで動画整理に役立てられる。
- **非目標**: KPI 計測／最適化、クラウド同期、署名・ストア公開の自動化、他サイト対応。

## 3. 対応環境・開発スタック

- **ブラウザ**: Chrome 109+ / Firefox 109+ (Manifest V3)
- **開発環境**: Node.js 25, TypeScript 5.0+, Plasmo Framework 0.90+
- **配布**: ローカル sideload 前提（開発者モードで拡張機能を読み込む）。ストア署名・公開は本仕様の対象外。
- **権限**: `activeTab`, `storage`, `scripting`, `https://www.nicovideo.jp/watch/*`

## 4. コアワークフロー

1. **視聴中比較**: 再生ページ右上の小型アイコンをホバーすると比較カードが開き、直近 N 件から比較対象を選び「良い・同じ・悪い」を登録。
2. **ログ補正**: 拡張ページから直近イベントを確認し、誤ったものを無効化または verdict を修正。
3. **ランキング活用**: 保存済み動画一覧でレーティング順・未確定動画（RD が高い動画）を確認し、視聴計画や整理に活かす。

## 5. ドメイン要件

- 比較イベント（CompareEvent）を操作することで状態を決定する。厳密なイベント再生モデルには固執せず、「最新の CompareEvent ログが残っていればレーティングを再計算できる」レベルを目指す（過去イベントの編集や置換を許容）。
  - 比較カードで選択動画を変更せずに連続評価した場合（前回評価の eventId が残っている場合）は、同一イベントの verdict と timestamp を更新する。
  - 選択動画を変更した後は、直近イベントと同じ組み合わせであっても新規イベントを作成する。
- マイリスト等との同期は行わず、比較時点の 2 動画と verdict を永続化する。
- 動画メタ／投稿者情報は watch ページの JSON-LD (`author.url`, `thumbnailUrl`) から取得し、`authorUrl` をキーに AuthorProfile を保持。再訪時は最新メタで VideoSnapshot/AuthorProfile を上書きする。
  - **JSON-LD 取得失敗時の挙動**:
    - 該当 videoId の VideoSnapshot が既に `nc_videos` に存在する場合：既存データを使用して比較イベント登録を許可（UI には警告アイコンを表示）
    - VideoSnapshot が存在しない場合：オーバーレイにエラーメッセージを表示し、比較入力を完全に抑制
    - いずれの場合もエラーログに記録し、ユーザーはページリロードで再取得を試行できる
    - JSON-LD の構造変更やフィールド欠損（`author.url` 不在など）も同様に扱う
- `nc_state.recentWindow` として opponentVideo 候補 (選択肢) の LRU を設定値の件数だけ保持する。LRU 更新は「比較イベントの storage 書き込み成功後」および「`currentVideoId` が新しい動画へ切り替わった際」に行い、比較に登場した currentVideo/opponentVideo や直前まで視聴していた動画を最新順に並べる（書き込み失敗時は LRU を更新しない）。currentVideo（現在再生中の動画）は別途 `nc_state.currentVideoId` で管理する。
  - **設定値変更時の LRU 再構築**: 「直近 100 件までの CompareEvent（disabled = true を除外）を時系列逆順に走査し、登場した opponentVideo を重複除去しながら新しい設定値ぶん埋める」アルゴリズムで LRU を再構築する。100 件の根拠は「最大設定値 10 × 10 倍のバッファ」として十分なイベント履歴を確保するため。`currentVideoId` は LRU に含めず、別途保持し続ける。
- イベントの無効化は CompareEvent に `disabled = true` をセットするフラグ運用とし、Options から「削除」操作を行うまでは `nc_events.items` から除去しない。

## 6. アーキテクチャ

技術アーキテクチャ/データフロー/責務分担の詳細は `docs/architecture.md` を正とする。
本書では UI 仕様やドメイン要件に関わる挙動のみを扱う。

## 7. データと永続化

データは `chrome.storage.local` に永続化する。
キー構造・スキーマ・JSON-LD 取得仕様・保存更新の詳細は `docs/architecture.md` と実装を正とする。

## 8. レーティングとリプレイ

レーティングは Glicko-2 を用い、比較イベント追加ごとに即時計算する。
Options から再計算（リプレイ）を実行できる。詳細手順は `docs/architecture.md` と実装を正とする。

## 9. UI 仕様

### 9.1 コンテンツオーバーレイ

実視聴ページ上に常駐するコンテンツオーバーレイは「比較操作を中断なく行う」ことだけを目的にし、細かな見た目やアニメーションは実装を正とする。UI の実態は `src/contents/overlay.ts` および補助資料 `docs/ui-overlay.md`（DOM/状態まとめ）を参照し、ここでは変えてはいけない機能要求のみを列挙する。

**不変要件**

- watch ページの DOM に固定表示され、`overlayAndCaptureEnabled` が true の間は常に現在視聴中の動画（left）と LRU から選択した動画（right）の比較を登録できる。
- chrome.storage/state から取得した `nc_state.recentWindow` を候補 Select に反映し、選択した videoId のタイトル・サムネイルなど基本情報を同じカード内で確認できる。
- 比較対象（opponent）はピン留めでき、`nc_state.pinnedOpponentVideoId` に保存される。ピン留め中は Select 変更を無効化し、ページリロード/拡張再起動後も固定状態を維持する。
- `pinnedOpponentVideoId` が再生中の動画と一致する場合は「比較不可」のステータスメッセージを表示し、verdict 入力を無効化する。
- verdict 入力（再生中の動画/引き分け/選択中の動画）は 1 アクションで送信でき、送信後は最新の state を再取得して UI を更新する。
- JSON-LD の取得状況を監視し、メタデータが不足しているときはステータスメッセージとともに verdict ボタンを無効化する（既存 VideoSnapshot がある場合は LRU 表示のみ継続してもよい）。
- `overlayAndCaptureEnabled` と `overlayAutoCloseMs` は `nc_settings` を唯一のソースとし、トグル変更 → UI 表示/非表示、マウスホバー解除 → 自動的にコントロールを閉じる動作が保証される。

**実装依存の要素**

- アイコンの有無、カードの開閉トリガー、グリッド構成、アクセシビリティ対応詳細などは `src/contents/overlay.ts` の内容に従って運用し、UI の変更はコードとスクリーンショット等の実装ドキュメントを更新して示す。
- 候補ラベルの表記、ステータスメッセージ文言、hover/auto-close の演出は頻繁に変わるため仕様書では固定しない（機能を満たしている限り実装を正とする）。

### 9.2 Popup

- 直近イベント一覧を表示（イベント ID と日時、current/opponent のサムネ表示、勝敗は `>` `=` `<` で表記）。
- `overlayAndCaptureEnabled` トグルを提供し、オーバーレイ表示と動画/author 情報の取得を ON/OFF できる（デフォルト ON）。その他の詳細設定は拡張ページへ誘導。

### 9.3 拡張ページ / Options

1. **評価済み動画一覧**: VideoSnapshot + 最新レーティングのテーブル（ページネーション: 50 件/ページ）。最新レーティングがある動画のみ表示。投稿者（名前）フィルタ／検索、ソート（タイトル / Rating / RD / 評価数 / 勝ち数 / 敗け数 / 最終判定日時）、昇順/降順切替。列は「サムネ / タイトル / 投稿者 / Rating / RD / 評価数 / 勝/分/敗 / 最終判定日時」。サムネに動画リンクを付与。
2. **評価イベント一覧**: CompareEvent テーブル（ページネーション: 100 件/ページ）。検索・評価フィルタ（勝ち / 引き分け / 負け）・無効化済み表示の切替・サムネ表示の切替。行アクションで無効化／復活・評価変更・削除（無効化済みのみ）を行う。詳細なUIは実装を参照。
3. **Options 設定**:
   - オーバーレイ自動閉鎖（ms）、比較候補数、Glicko-2 初期値、イベント一覧サムネ表示を編集。Glicko-2 初期値変更時はレーティング再計算、比較候補数変更時は recentWindow を再構築。
   - レーティング再計算ボタン。
   - データ操作:
   - 全データ削除（設定・履歴・レーティング等を初期化）。confirm で確認してから実行。
   - JSON エクスポート/インポート (`nc_*` 一括)。`nc_authors`/`nc_videos` 欠如時は UI に「データ未取得」を表示。インポート後は `nc_ratings` のインポート内容に関わらず全イベントを再計算し、ローカルで `nc_ratings` を再生成する。
   - 「イベントから辿れない情報を削除」ボタンで `nc_ratings` の孤立 videoId、および参照のない `nc_videos`/`nc_authors` を削除し、結果（削除件数 or 未検出）を表示。

## 10. データ操作・メンテナンス

- **JSON エクスポート/インポート**: Options から手動実行。`nc_meta.schemaVersion`（現行: `"1.0.0"`）が不一致の場合:
  - 旧バージョン → 新バージョン: マイグレーション関数を実行してインポート（v1.0.0 では未実装）
  - 新バージョン → 旧バージョン: エラーメッセージを表示し、拒否
  - `schemaVersion` 未定義データ: 初期バージョンとみなし、デフォルト値で補完してインポート
- **全データ削除**: 設定・履歴・レーティングを含む `nc_*` を初期化し、confirm で確認してから実行。
- `nc_authors`/`nc_videos` の整合性チェックは行わないが、欠損は UI で明示。
- クリーンアップ実装:
  - `chrome.alarms` で24時間ごとに発火し、`runAutoCleanupIfNeeded` が `nc_meta.lastCleanupAt` を参照して24時間以上経過している場合のみ実行する。参照されない `nc_ratings`/`nc_videos`/`nc_authors` を削除する（評価済みイベントで参照されている動画と、現在再生中の動画は保持）。最終実行時刻は `nc_meta.lastCleanupAt` に保存する。ユーザーが手動でクリーンアップボタンを押した場合も同じ処理を実行する。
- 無効化操作は CompareEvent の `disabled` を true に設定する形で即時反映し、Undo 操作で false に戻せるようにする。Options から「削除」を実行した場合のみ、該当イベントを `nc_events.items` から物理削除する。

## 11. エラー処理・セキュリティ

詳細は `docs/architecture.md` と実装を正とする。
UI 上でユーザーに見せる振る舞いは本書の該当箇所に従う。

---

実装中に追加決定が生じた場合は、本書の該当章を更新すること。
